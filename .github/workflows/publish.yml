name: Publish to PyPI

permissions:
  contents: read

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v0.2.1, v1.0.0, etc.
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0 # fetch all history and tags for hatch-vcs

      - uses: ./.github/actions/setup-python

      - name: Prepare build environment
        uses: ./.github/actions/prepare-build

      - name: Build and validate package
        uses: ./.github/actions/build-and-validate-package

      - name: Smoke test built wheel
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl

      - name: Test imports and CLI
        run: |
          source .venv/bin/activate
          python -c "import sabr; print('✅ sabr import OK')"
          python -c "import ANARCI; print('✅ ANARCI import OK')"
          sabr --help > /dev/null && echo "✅ sabr CLI OK"

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
