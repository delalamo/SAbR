name: SAbDab Test Set Analysis

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "Number of entries to process (0 = all)"
        required: false
        default: "75"
        type: string
      filter_to_imgt:
        description: "Filter residues to IMGT positions 1-128 only"
        required: false
        default: false
        type: boolean
      ignore_variable_length_regions:
        description: "Ignore variable-length regions (CDRs and positions 79-84)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: ./.github/actions/setup-python

      - name: Install dependencies
        run: pip install -e .

      - name: Run SAbDab test set analysis
        run: |
          python scripts/imgt_benchmark.py \
            --csv scripts/sabdab_testset.csv \
            --output sabdab_testset_results.json \
            --limit ${{ inputs.limit }} \
            --cache-dir /tmp/pdb_cache \
            ${{ inputs.filter_to_imgt == true && '--filter-to-imgt' || '' }} \
            ${{ inputs.ignore_variable_length_regions == true && '--ignore-variable-length-regions' || '' }}

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: sabdab-testset-results
          path: sabdab_testset_results.json
          retention-days: 30
